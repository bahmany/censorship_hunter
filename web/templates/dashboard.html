<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hunter Admin</title>
<style>
:root {
  --bg: #0a0e14;
  --bg-card: #131920;
  --bg-card-hover: #1a2230;
  --border: #1e2a36;
  --text: #c5d0dc;
  --text-dim: #6b7b8d;
  --text-bright: #e8edf2;
  --accent: #00bfff;
  --accent-glow: rgba(0,191,255,.15);
  --success: #00e676;
  --warning: #ffab00;
  --error: #ff5252;
  --gold: #ffd700;
  --silver: #c0c0c0;
  --radius: 8px;
  --gap: 10px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg); color: var(--text); font-size: 13px; line-height: 1.5;
  min-height: 100vh; overflow-x: hidden;
}
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.header {
  display: flex; align-items: center; gap: 14px; padding: 8px 16px;
  background: var(--bg-card); border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 100;
}
.logo { font-size: 15px; font-weight: 800; letter-spacing: 1px; color: var(--accent); display: flex; align-items: center; gap: 6px; }
.logo svg { width: 20px; height: 20px; }
.badge {
  display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 10px;
  font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px;
}
.badge-phase { background: var(--accent-glow); color: var(--accent); border: 1px solid rgba(0,191,255,.3); }
.badge-phase.scraping { color: #00bfff; }
.badge-phase.validating { background: rgba(255,171,0,.12); color: #ffab00; border-color: rgba(255,171,0,.3); }
.badge-phase.balancing { background: rgba(0,230,118,.12); color: #00e676; border-color: rgba(0,230,118,.3); }
.badge-phase.sleeping { background: rgba(107,123,141,.12); color: #6b7b8d; border-color: rgba(107,123,141,.3); }
.badge-phase.starting { background: rgba(255,82,82,.12); color: #ff5252; border-color: rgba(255,82,82,.3); }
.header-stats { display: flex; align-items: center; gap: 14px; margin-left: auto; font-size: 11px; color: var(--text-dim); }
.header-stats .sv { color: var(--text-bright); font-weight: 600; }
.dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; animation: pulse 2s ease-in-out infinite; }
.dot-ok { background: var(--success); box-shadow: 0 0 5px var(--success); }
.dot-warn { background: var(--warning); }
.dot-err { background: var(--error); }
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:.5; } }

.main {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: var(--gap); padding: var(--gap); max-width: 1480px; margin: 0 auto;
}
.full { grid-column: 1 / -1; }

.card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
.card-h {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 12px; border-bottom: 1px solid var(--border);
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .7px; color: var(--text-dim);
}
.card-b { padding: 8px 12px; }

table { width: 100%; border-collapse: collapse; }
th { text-align: left; padding: 5px 7px; font-size: 10px; text-transform: uppercase; letter-spacing: .4px; color: var(--text-dim); border-bottom: 1px solid var(--border); font-weight: 600; }
td { padding: 5px 7px; border-bottom: 1px solid rgba(30,42,54,.4); font-size: 12px; }
tr:last-child td { border-bottom: none; }
td.n { text-align: right; font-family: 'Cascadia Code','SF Mono',monospace; font-weight: 600; }
.sd { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 5px; }
.sd-ok { background: var(--success); }
.sd-run { background: var(--accent); animation: pulse 1s infinite; }
.sd-wait { background: var(--text-dim); }
.sd-fail { background: var(--error); }

.metrics { grid-column: 1/-1; display: grid; grid-template-columns: repeat(auto-fit, minmax(110px,1fr)); gap: var(--gap); }
.mc { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px; text-align: center; }
.mc .l { font-size: 9px; color: var(--text-dim); text-transform: uppercase; letter-spacing: .4px; margin-bottom: 2px; }
.mc .v { font-size: 20px; font-weight: 800; font-family: 'Cascadia Code','SF Mono',monospace; }

.progress-bar { height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 4px; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 3px; transition: width .5s; }

.log-box { height: 220px; overflow-y: auto; padding: 4px 8px; font-family: 'Cascadia Code','SF Mono','Consolas',monospace; font-size: 11px; line-height: 1.6; }
.le { white-space: nowrap; }
.lt { color: var(--text-dim); }
.ll { font-weight: 700; margin: 0 3px; }
.ll.INFO { color: var(--accent); }
.ll.WARNING { color: var(--warning); }
.ll.ERROR { color: var(--error); }
.ll.DEBUG { color: var(--text-dim); }

.cmd-bar { grid-column: 1/-1; display: flex; gap: 6px; align-items: center; }
.cmd-bar .card { flex: 1; display: flex; align-items: center; padding: 0; }
.ci { flex: 1; background: transparent; border: none; color: var(--text); padding: 8px 12px; font-family: 'Cascadia Code',monospace; font-size: 12px; outline: none; }
.ci::placeholder { color: var(--text-dim); }
.btn {
  padding: 7px 14px; border: 1px solid var(--border); border-radius: var(--radius);
  background: var(--bg-card); color: var(--text); font-size: 10px; font-weight: 600;
  cursor: pointer; transition: all .15s; text-transform: uppercase; letter-spacing: .4px; white-space: nowrap;
}
.btn:hover { background: var(--bg-card-hover); border-color: var(--accent); color: var(--accent); }
.btn:disabled { opacity: .4; cursor: not-allowed; }
.btn-p { background: rgba(0,191,255,.12); border-color: var(--accent); color: var(--accent); }
.btn-p:hover { background: rgba(0,191,255,.25); }
.btn-d { border-color: var(--error); color: var(--error); }
.btn-d:hover { background: rgba(255,82,82,.12); }
.btn-s { border-color: var(--success); color: var(--success); }
.btn-s:hover { background: rgba(0,230,118,.12); }

/* Traffic chart */
.chart-wrap { position: relative; height: 100px; padding: 4px 0; }
canvas { width: 100% !important; height: 100% !important; }

/* Modal */
.mo { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.7); backdrop-filter: blur(4px); z-index: 200; justify-content: center; align-items: center; }
.mo.active { display: flex; }
.md { background: var(--bg-card); border: 1px solid var(--accent); border-radius: 12px; padding: 24px; width: 360px; max-width: 90vw; box-shadow: 0 0 30px rgba(0,191,255,.15); }
.md h2 { font-size: 15px; color: var(--accent); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
.md p { color: var(--text-dim); font-size: 12px; margin-bottom: 14px; }
.md input { width: 100%; padding: 10px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text-bright); font-size: 18px; font-family: 'Cascadia Code',monospace; text-align: center; letter-spacing: 6px; outline: none; margin-bottom: 14px; }
.md input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
.md input.pw { letter-spacing: 3px; }
.md-a { display: flex; gap: 6px; }
.md-a .btn { flex: 1; padding: 9px; text-align: center; }

/* Export modal */
.export-box { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 11px; word-break: break-all; white-space: pre-wrap; margin-bottom: 12px; color: var(--text); }

@media (max-width: 768px) {
  .main { grid-template-columns: 1fr; }
  .header { flex-wrap: wrap; gap: 6px; }
  .header-stats { margin-left: 0; flex-wrap: wrap; }
  .log-box { height: 160px; }
  .metrics { grid-template-columns: repeat(3,1fr); }
}
</style>
</head>
<body>

<div class="header">
  <div class="logo">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
    HUNTER
  </div>
  <span class="badge badge-phase" id="phase-badge">STARTING</span>
  <span style="color:var(--text-dim);font-size:11px">C#<span id="cycle" class="sv">0</span></span>
  <div class="header-stats">
    <span><span class="dot dot-ok" id="status-dot"></span> <span id="mode">NORMAL</span></span>
    <span>Mem <span id="mem-pct" class="sv">0%</span> <span id="mem-detail" style="color:var(--text-dim)"></span></span>
    <span>CPU <span id="cpu-pct" class="sv">-</span></span>
    <span>Up <span id="uptime" class="sv">0m</span></span>
  </div>
</div>

<div class="main">

  <!-- Metrics -->
  <div class="metrics">
    <div class="mc"><div class="l">Scraped</div><div class="v" style="color:var(--accent)" id="m-scraped">0</div></div>
    <div class="mc"><div class="l">Tested</div><div class="v" id="m-tested">0</div></div>
    <div class="mc"><div class="l">Gold</div><div class="v" style="color:var(--gold)" id="m-gold">0</div></div>
    <div class="mc"><div class="l">Silver</div><div class="v" style="color:var(--silver)" id="m-silver">0</div></div>
    <div class="mc"><div class="l">Failed</div><div class="v" style="color:var(--error)" id="m-failed">0</div></div>
    <div class="mc"><div class="l">Backends</div><div class="v" style="color:var(--success)" id="m-backends">0</div></div>
    <div class="mc" style="grid-column:span 2;">
      <div class="l">Benchmark</div>
      <div style="display:flex;align-items:center;gap:6px;justify-content:center;margin-top:2px;">
        <span id="bench-text" style="font-size:11px;color:var(--text-dim)">Waiting</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="bench-bar" style="width:0%"></div></div>
    </div>
  </div>

  <!-- Sources -->
  <div class="card">
    <div class="card-h"><span>üì° Sources</span><span id="total-scraped" style="color:var(--accent)">0</span></div>
    <div class="card-b" style="padding:0">
      <table>
        <thead><tr><th>Source</th><th>Status</th><th style="text-align:right">Count</th></tr></thead>
        <tbody id="sources-body"><tr><td colspan="3" style="color:var(--text-dim);text-align:center;padding:16px">Waiting...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Balancers + DPI -->
  <div class="card">
    <div class="card-h"><span>‚öñÔ∏è Balancers</span></div>
    <div class="card-b" style="padding:0">
      <table>
        <thead><tr><th>Port</th><th>Backends</th><th>Status</th></tr></thead>
        <tbody>
          <tr><td id="bp1">10808</td><td class="n" id="bb1">0</td><td id="bs1"><span class="sd sd-wait"></span>starting</td></tr>
          <tr><td id="bp2">10809</td><td class="n" id="bb2">0</td><td id="bs2"><span class="sd sd-wait"></span>starting</td></tr>
        </tbody>
      </table>
    </div>
    <div class="card-h" style="border-top:1px solid var(--border);border-bottom:none;"><span>üõ°Ô∏è DPI / Network</span></div>
    <div class="card-b">
      <div style="display:flex;gap:12px;font-size:11px;flex-wrap:wrap;">
        <span>Strategy: <strong id="dpi-strategy" style="color:var(--accent)">-</strong></span>
        <span>Network: <strong id="dpi-network">-</strong></span>
        <span>Telegram: <strong id="tg-status">-</strong></span>
      </div>
    </div>
  </div>

  <!-- Traffic Chart -->
  <div class="card full">
    <div class="card-h">
      <span>üìä Network Traffic</span>
      <div style="display:flex;gap:10px;font-size:10px;">
        <span style="color:#00e676">‚ñ≤ Upload</span>
        <span style="color:#00bfff">‚ñº Download</span>
        <span id="traffic-rate" style="color:var(--text-dim)">0 KB/s</span>
      </div>
    </div>
    <div class="card-b">
      <div class="chart-wrap"><canvas id="traffic-canvas"></canvas></div>
    </div>
  </div>

  <!-- Top Configs -->
  <div class="card">
    <div class="card-h">
      <span>üèÜ Active Backends</span>
      <div style="display:flex;gap:4px;">
        <button class="btn btn-s" onclick="exportConfigs('gold')" style="font-size:9px;padding:4px 8px;">Export Gold</button>
        <button class="btn" onclick="exportConfigs('silver')" style="font-size:9px;padding:4px 8px;">Export Silver</button>
      </div>
    </div>
    <div class="card-b" style="padding:0;max-height:180px;overflow-y:auto;">
      <table>
        <thead><tr><th>#</th><th>Config</th><th style="text-align:right">Latency</th><th>Health</th></tr></thead>
        <tbody id="top-configs-body"><tr><td colspan="4" style="color:var(--text-dim);text-align:center;padding:12px">No backends</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Connected Clients -->
  <div class="card">
    <div class="card-h"><span>üë• Connected Clients</span><span id="client-count" style="color:var(--accent)">0</span></div>
    <div class="card-b" style="padding:0;max-height:180px;overflow-y:auto;">
      <table>
        <thead><tr><th>IP Address</th><th style="text-align:right">Connections</th><th>Port</th></tr></thead>
        <tbody id="clients-body"><tr><td colspan="3" style="color:var(--text-dim);text-align:center;padding:12px">No external clients</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Telegram Auth -->
  <div class="card full">
    <div class="card-h">
      <span>‚úàÔ∏è Telegram Authentication</span>
      <span id="tg-session-badge" class="badge" style="font-size:9px">checking</span>
    </div>
    <div class="card-b" style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
      <div style="flex:1;min-width:180px;">
        <div style="font-size:11px;color:var(--text-dim);margin-bottom:2px;">Session</div>
        <div id="tg-session-info" style="font-size:12px;">Checking...</div>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="btn btn-p" id="tg-login-btn" onclick="telegramLogin()">üîë Login Telegram</button>
        <button class="btn" onclick="checkTelegramStatus()">üîÑ Check</button>
      </div>
    </div>
  </div>

  <!-- System Info -->
  <div class="card full">
    <div class="card-h"><span>üíª System Info</span><button class="btn" onclick="loadSystemInfo()" style="font-size:9px;padding:3px 8px;">Refresh</button></div>
    <div class="card-b" id="sys-info" style="display:flex;gap:20px;flex-wrap:wrap;font-size:12px;">
      <span>Loading...</span>
    </div>
  </div>

  <!-- Logs -->
  <div class="card full">
    <div class="card-h">
      <span>üìã Logs</span>
      <div style="display:flex;gap:4px;">
        <button class="btn" onclick="toggleAutoScroll()" id="as-btn">‚¨á Auto</button>
        <button class="btn" onclick="clearLogs()">Clear</button>
      </div>
    </div>
    <div class="log-box" id="log-box"></div>
  </div>

  <!-- Command Bar -->
  <div class="cmd-bar">
    <div class="card"><input class="ci" id="cmd-input" type="text" placeholder="Command: status, force_cycle, clear_pid" onkeydown="if(event.key==='Enter')sendCommand()"></div>
    <button class="btn btn-p" onclick="sendCommand()">Send</button>
    <button class="btn" onclick="sendCmd('force_cycle')">Force Cycle</button>
    <button class="btn btn-d" onclick="sendCmd('clear_pid')">Clear PID</button>
  </div>

</div>

<!-- Auth Modal -->
<div class="mo" id="auth-modal">
  <div class="md">
    <h2 id="auth-title">üîê Telegram Auth</h2>
    <p id="auth-message">Enter verification code.</p>
    <input type="text" id="auth-input" placeholder="12345" maxlength="20" autocomplete="off" onkeydown="if(event.key==='Enter')submitAuth()">
    <div class="md-a">
      <button class="btn btn-p" onclick="submitAuth()">Submit</button>
      <button class="btn btn-d" onclick="cancelAuth()">Cancel</button>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div class="mo" id="export-modal">
  <div class="md" style="width:500px;">
    <h2 id="export-title">üì¶ Export Configs</h2>
    <p id="export-info">Loading...</p>
    <div class="export-box" id="export-box"></div>
    <div class="md-a">
      <button class="btn btn-p" onclick="copyExport()">üìã Copy All</button>
      <button class="btn" onclick="document.getElementById('export-modal').classList.remove('active')">Close</button>
    </div>
  </div>
</div>

<script>
let autoScroll = true, logCount = 0, lastAuthPending = null;
const MAX_LOG = 400;
const logBox = document.getElementById('log-box');
const authModal = document.getElementById('auth-modal');

// --- Traffic Chart (pure canvas, no library) ---
const trafficData = {up: [], down: []};
const MAX_POINTS = 120;
const canvas = document.getElementById('traffic-canvas');
const ctx = canvas.getContext('2d');

function drawTrafficChart() {
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  const W = rect.width, H = rect.height;
  ctx.clearRect(0, 0, W, H);

  if (trafficData.up.length < 2) return;

  const allVals = [...trafficData.up, ...trafficData.down];
  const maxVal = Math.max(10, ...allVals) * 1.1;

  // Grid lines
  ctx.strokeStyle = 'rgba(30,42,54,.6)';
  ctx.lineWidth = 0.5;
  for (let i = 1; i <= 3; i++) {
    const y = H - (H * i / 4);
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }

  function drawLine(data, color, alpha) {
    const len = data.length;
    const step = W / (MAX_POINTS - 1);
    const startX = W - (len - 1) * step;
    ctx.beginPath();
    ctx.moveTo(startX, H);
    for (let i = 0; i < len; i++) {
      const x = startX + i * step;
      const y = H - (data[i] / maxVal) * (H - 4);
      ctx.lineTo(x, y);
    }
    ctx.lineTo(startX + (len - 1) * step, H);
    ctx.closePath();
    ctx.fillStyle = color.replace('1)', alpha + ')');
    ctx.fill();
    // Line on top
    ctx.beginPath();
    for (let i = 0; i < len; i++) {
      const x = startX + i * step;
      const y = H - (data[i] / maxVal) * (H - 4);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.strokeStyle = color;
    ctx.lineWidth = 1.5;
    ctx.stroke();
  }

  drawLine(trafficData.down, 'rgba(0,191,255,1)', 0.08);
  drawLine(trafficData.up, 'rgba(0,230,118,1)', 0.08);

  // Scale label
  ctx.fillStyle = 'rgba(107,123,141,.6)';
  ctx.font = '9px sans-serif';
  ctx.fillText(formatKB(maxVal), 2, 10);
}

function formatKB(kb) {
  if (kb >= 1024) return (kb/1024).toFixed(1) + ' MB/s';
  return Math.round(kb) + ' KB/s';
}

function updateTraffic() {
  fetch('/api/traffic').then(r=>r.json()).then(data => {
    trafficData.up = data.map(d => d.up);
    trafficData.down = data.map(d => d.down);
    if (data.length > 0) {
      const last = data[data.length - 1];
      document.getElementById('traffic-rate').textContent = '‚Üë' + formatKB(last.up) + ' ‚Üì' + formatKB(last.down);
    }
    drawTrafficChart();
  }).catch(()=>{});
}

// --- SSE Logs ---
function startLogStream() {
  const es = new EventSource('/api/logs/stream');
  es.onmessage = e => { try { appendLog(JSON.parse(e.data)); } catch(x){} };
  es.onerror = () => { es.close(); setTimeout(startLogStream, 3000); };
}
function appendLog(e) {
  const d = document.createElement('div');
  d.className = 'le';
  const lv = e.level||'INFO';
  d.innerHTML = `<span class="lt">${e.timestamp}</span> <span class="ll ${lv}">${lv.padEnd(7)}</span> <span>${esc(e.message)}</span>`;
  logBox.appendChild(d);
  while (logBox.children.length > MAX_LOG) logBox.removeChild(logBox.firstChild);
  if (autoScroll) logBox.scrollTop = logBox.scrollHeight;
}
function esc(t) { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
function clearLogs() { logBox.innerHTML=''; }
function toggleAutoScroll() {
  autoScroll=!autoScroll;
  const b=document.getElementById('as-btn');
  b.style.borderColor=autoScroll?'var(--accent)':'var(--border)';
  b.style.color=autoScroll?'var(--accent)':'var(--text-dim)';
}

// --- Status Poll ---
function pollStatus() {
  fetch('/api/status').then(r=>r.json()).then(updateDashboard).catch(()=>{});
}
function updateDashboard(s) {
  const phase = s.phase||'starting';
  const pb = document.getElementById('phase-badge');
  pb.textContent = phase.toUpperCase(); pb.className = 'badge badge-phase ' + phase;
  document.getElementById('cycle').textContent = s.cycle||0;
  document.getElementById('mode').textContent = s.mode||'NORMAL';
  const mp = (s.memory_pct||0).toFixed(0);
  const mEl = document.getElementById('mem-pct');
  mEl.textContent = mp+'%';
  mEl.style.color = mp>90?'var(--error)':mp>80?'var(--warning)':'var(--success)';
  if (s.memory_total_gb>0) document.getElementById('mem-detail').textContent = `(${(s.memory_used_gb||0).toFixed(1)}/${(s.memory_total_gb||0).toFixed(1)}G)`;
  document.getElementById('uptime').textContent = s.uptime||'0m';
  document.getElementById('status-dot').className = 'dot '+(mp>90?'dot-err':mp>80?'dot-warn':'dot-ok');

  const ts = Object.values(s.sources||{}).reduce((a,b)=>a+(b.count||0),0);
  document.getElementById('m-scraped').textContent = ts;
  document.getElementById('m-tested').textContent = s.total_tested||0;
  document.getElementById('m-gold').textContent = s.gold||0;
  document.getElementById('m-silver').textContent = s.silver||0;
  document.getElementById('m-failed').textContent = s.failed||0;

  // Backends count
  const bc = (s.bal_main_backends||0) + (s.bal_gemini_backends||0);
  document.getElementById('m-backends').textContent = bc;

  // Bench
  const bt=s.bench_total||0, bd=s.bench_done||0;
  if(bt>0){const p=Math.round(bd*100/bt);document.getElementById('bench-text').textContent=`${bd}/${bt} (${p}%)`;document.getElementById('bench-bar').style.width=p+'%';}
  else{document.getElementById('bench-text').textContent='Waiting';document.getElementById('bench-bar').style.width='0%';}

  // Sources
  const src=s.sources||{}, sk=Object.keys(src), sb=document.getElementById('sources-body');
  if(sk.length>0){sb.innerHTML='';let tot=0;sk.forEach(n=>{const x=src[n],st=x.status||'waiting',c=x.count||0;tot+=c;const dc=st==='done'?'sd-ok':st==='fetching'?'sd-run':st==='failed'?'sd-fail':'sd-wait';const tr=document.createElement('tr');tr.innerHTML=`<td>${esc(n)}</td><td><span class="sd ${dc}"></span>${st}</td><td class="n">${c}</td>`;sb.appendChild(tr);});document.getElementById('total-scraped').textContent=tot+' configs';}

  // Balancers
  setBal('1',s.bal_main_port||10808,s.bal_main_backends||0,s.bal_main_status||'starting');
  setBal('2',s.bal_gemini_port||10809,s.bal_gemini_backends||0,s.bal_gemini_status||'starting');
  document.getElementById('dpi-strategy').textContent=s.dpi_strategy||'-';
  document.getElementById('dpi-network').textContent=s.dpi_network||'-';
  document.getElementById('tg-status').textContent=s.tg_status||'-';

  handleAuth(s.auth_pending);
}
function setBal(i,port,backs,st){
  document.getElementById('bp'+i).textContent=port;
  document.getElementById('bb'+i).textContent=backs;
  const dc=st==='OK'?'sd-ok':st==='starting'?'sd-wait':'sd-fail';
  document.getElementById('bs'+i).innerHTML=`<span class="sd ${dc}"></span>${st}`;
}

// --- Auth ---
function handleAuth(p) {
  if(p&&(!lastAuthPending||lastAuthPending.type!==p.type)){
    lastAuthPending=p;
    const inp=document.getElementById('auth-input');
    if(p.type==='code'){document.getElementById('auth-title').textContent='üîê Verification Code';document.getElementById('auth-message').textContent=p.message||'Enter 5-digit code';inp.placeholder='12345';inp.type='text';inp.className='';inp.maxLength=5;}
    else{document.getElementById('auth-title').textContent='üîê 2FA Password';document.getElementById('auth-message').textContent=p.message||'Enter 2FA password';inp.placeholder='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';inp.type='password';inp.className='pw';inp.maxLength=100;}
    inp.value='';authModal.classList.add('active');setTimeout(()=>inp.focus(),100);
  } else if(!p){lastAuthPending=null;authModal.classList.remove('active');}
}
function submitAuth(){const v=document.getElementById('auth-input').value.trim();if(!v)return;fetch('/api/auth/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({value:v})}).then(r=>r.json()).then(d=>{if(d.ok){authModal.classList.remove('active');lastAuthPending=null;}});}
function cancelAuth(){fetch('/api/auth/cancel',{method:'POST'}).then(()=>{authModal.classList.remove('active');lastAuthPending=null;});}

// --- Commands ---
function sendCommand(){const i=document.getElementById('cmd-input'),c=i.value.trim();if(!c)return;sendCmd(c);i.value='';}
function sendCmd(c){fetch('/api/command',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:c})}).then(r=>r.json()).then(d=>{appendLog({timestamp:ts(),level:d.ok?'INFO':'WARNING',message:`[CMD] ${c}: ${d.message||'OK'}`});}).catch(()=>{appendLog({timestamp:'--:--:--',level:'ERROR',message:`[CMD] ${c}: error`});});}
function ts(){return new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});}

// --- Telegram Login ---
let tgBusy=false;
function checkTelegramStatus(){
  fetch('/api/telegram/status').then(r=>r.json()).then(d=>{
    const b=document.getElementById('tg-session-badge'),info=document.getElementById('tg-session-info'),btn=document.getElementById('tg-login-btn');
    if(d.has_session){b.textContent='SESSION OK';b.style.cssText='font-size:9px;background:rgba(0,230,118,.12);color:var(--success);border:1px solid rgba(0,230,118,.3);padding:2px 8px;border-radius:10px;';info.innerHTML='<span style="color:var(--success)">‚úì</span> '+esc(d.session_file);btn.textContent='üîë Re-Login';}
    else{b.textContent='NO SESSION';b.style.cssText='font-size:9px;background:rgba(255,82,82,.12);color:var(--error);border:1px solid rgba(255,82,82,.3);padding:2px 8px;border-radius:10px;';info.innerHTML='<span style="color:var(--error)">‚úó</span> No session. Click Login.';btn.textContent='üîë Login Telegram';}
  }).catch(()=>{});
}
function telegramLogin(){
  if(tgBusy)return;tgBusy=true;
  const btn=document.getElementById('tg-login-btn');btn.disabled=true;btn.textContent='‚è≥ Connecting...';btn.style.opacity='.5';
  appendLog({timestamp:ts(),level:'INFO',message:'[Telegram] Starting login (via SSH/proxy)...'});
  fetch('/api/telegram/login',{method:'POST'}).then(r=>r.json()).then(d=>{
    if(d.waiting){btn.textContent='‚è≥ Waiting for code...';appendLog({timestamp:ts(),level:'INFO',message:'[Telegram] '+d.message});pollLoginDone();}
    else if(d.ok){appendLog({timestamp:ts(),level:'INFO',message:'[Telegram] '+d.message});resetTgBtn(true);}
    else{appendLog({timestamp:ts(),level:'ERROR',message:'[Telegram] '+(d.error||'Failed')});resetTgBtn(false);}
  }).catch(e=>{appendLog({timestamp:'--:--:--',level:'ERROR',message:'[Telegram] '+e});resetTgBtn(false);});
}
function pollLoginDone(){let c=0;const iv=setInterval(()=>{c++;fetch('/api/telegram/status').then(r=>r.json()).then(d=>{if(!d.auth_pending&&c>2){clearInterval(iv);checkTelegramStatus();appendLog({timestamp:ts(),level:'INFO',message:d.has_session?'[Telegram] Login OK! Session saved.':'[Telegram] Login failed.'});resetTgBtn(d.has_session);}}).catch(()=>{});if(c>=150){clearInterval(iv);resetTgBtn(false);}},2000);}
function resetTgBtn(ok){tgBusy=false;const b=document.getElementById('tg-login-btn');b.disabled=false;b.style.opacity='1';b.textContent=ok?'üîë Re-Login':'üîë Login Telegram';checkTelegramStatus();}

// --- Top Configs ---
function loadTopConfigs(){
  fetch('/api/configs/top').then(r=>r.json()).then(data=>{
    const tb=document.getElementById('top-configs-body');
    if(!data.length){tb.innerHTML='<tr><td colspan="4" style="color:var(--text-dim);text-align:center;padding:12px">No backends</td></tr>';return;}
    tb.innerHTML='';
    data.forEach((c,i)=>{const tr=document.createElement('tr');const hc=c.healthy?'sd-ok':'sd-fail';tr.innerHTML=`<td class="n">${i+1}</td><td style="font-size:11px;font-family:monospace;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.uri_short)}</td><td class="n">${c.latency}ms</td><td><span class="sd ${hc}"></span>${c.healthy?'OK':'down'}</td>`;tb.appendChild(tr);});
  }).catch(()=>{});
}

// --- Connected Clients ---
function loadClients(){
  fetch('/api/clients').then(r=>r.json()).then(data=>{
    const tb=document.getElementById('clients-body');
    document.getElementById('client-count').textContent=data.length;
    if(!data.length){tb.innerHTML='<tr><td colspan="3" style="color:var(--text-dim);text-align:center;padding:12px">No external clients</td></tr>';return;}
    tb.innerHTML='';
    data.forEach(c=>{const tr=document.createElement('tr');tr.innerHTML=`<td style="font-family:monospace">${esc(c.ip)}</td><td class="n">${c.connections}</td><td class="n">${c.port}</td>`;tb.appendChild(tr);});
  }).catch(()=>{});
}

// --- Export ---
function exportConfigs(tier){
  fetch('/api/configs/export?tier='+tier).then(r=>r.json()).then(d=>{
    document.getElementById('export-title').textContent='üì¶ '+tier.toUpperCase()+' Configs';
    document.getElementById('export-info').textContent=d.count+' configs in '+d.file;
    document.getElementById('export-box').textContent=d.configs.join('\n');
    document.getElementById('export-modal').classList.add('active');
  }).catch(()=>{});
}
function copyExport(){const t=document.getElementById('export-box').textContent;navigator.clipboard.writeText(t).then(()=>{appendLog({timestamp:ts(),level:'INFO',message:'[Export] Copied to clipboard'});});}

// --- System Info ---
function loadSystemInfo(){
  fetch('/api/system').then(r=>r.json()).then(d=>{
    const el=document.getElementById('sys-info');
    let h='';
    const items=[
      ['Host',d.hostname],['Platform',d.platform],['Python',d.python],
      ['CPUs',d.cpu_count],['CPU%',d.cpu_pct!==undefined?d.cpu_pct+'%':'-'],
      ['RAM',(d.memory_used_gb||0)+'/'+(d.memory_total_gb||0)+' GB ('+d.memory_pct+'%)'],
      ['Disk',(d.disk_used_gb||0)+'/'+(d.disk_total_gb||0)+' GB ('+d.disk_pct+'%)'],
      ['Net ‚Üë',(d.net_sent_mb||0)+' MB'],['Net ‚Üì',(d.net_recv_mb||0)+' MB'],
      ['PID',d.pid],
    ];
    items.forEach(([k,v])=>{h+=`<span><span style="color:var(--text-dim)">${k}:</span> <strong>${v||'-'}</strong></span>`;});
    el.innerHTML=h;
    if(d.cpu_pct!==undefined)document.getElementById('cpu-pct').textContent=d.cpu_pct+'%';
  }).catch(()=>{});
}

// --- Init ---
startLogStream();
pollStatus(); setInterval(pollStatus, 2000);
checkTelegramStatus(); setInterval(checkTelegramStatus, 15000);
updateTraffic(); setInterval(updateTraffic, 2000);
loadTopConfigs(); setInterval(loadTopConfigs, 10000);
loadClients(); setInterval(loadClients, 5000);
loadSystemInfo(); setInterval(loadSystemInfo, 30000);
document.getElementById('as-btn').style.borderColor='var(--accent)';
document.getElementById('as-btn').style.color='var(--accent)';
window.addEventListener('resize', drawTrafficChart);
</script>
</body>
</html>
